// This Pine Script® code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/
// © SwingTradeAnalyzer

//@version=6
indicator("Swing Trade Analyzer - S&R Levels", shorttitle="STA S&R", overlay=true, max_lines_count=500, max_labels_count=500)

// ============================================
// INPUTS
// ============================================
grp_pivot = "Pivot Detection"
pivotLeft = input.int(5, "Pivot Left Bars", minval=1, maxval=20, group=grp_pivot)
pivotRight = input.int(5, "Pivot Right Bars", minval=1, maxval=20, group=grp_pivot)
maxLevels = input.int(5, "Max Levels Each Side", minval=1, maxval=10, group=grp_pivot)

grp_display = "Display Settings"
showSupport = input.bool(true, "Show Support Lines", group=grp_display)
showResistance = input.bool(true, "Show Resistance Lines", group=grp_display)
showLabels = input.bool(true, "Show Price Labels", group=grp_display)
extendLines = input.bool(true, "Extend Lines Right", group=grp_display)

grp_colors = "Colors"
supportColor = input.color(color.new(color.green, 30), "Support Color", group=grp_colors)
resistanceColor = input.color(color.new(color.red, 30), "Resistance Color", group=grp_colors)
mtfSupportColor = input.color(color.new(color.lime, 0), "MTF Support (Strong)", group=grp_colors)
mtfResistanceColor = input.color(color.new(color.fuchsia, 0), "MTF Resistance (Strong)", group=grp_colors)

grp_mtf = "Multi-Timeframe Confluence"
useMTF = input.bool(true, "Enable MTF Confluence", group=grp_mtf)
mtfTimeframe = input.timeframe("W", "Higher Timeframe", group=grp_mtf)
confluenceThreshold = input.float(1.5, "Confluence Threshold %", minval=0.5, maxval=5.0, step=0.5, group=grp_mtf)

grp_fib = "Fibonacci Extensions (ATH)"
useFibonacci = input.bool(true, "Use Fibonacci for ATH", group=grp_fib)
athThreshold = input.float(5.0, "ATH Threshold %", minval=1.0, maxval=10.0, group=grp_fib)

// ============================================
// PIVOT DETECTION
// ============================================
pivotHigh = ta.pivothigh(high, pivotLeft, pivotRight)
pivotLow = ta.pivotlow(low, pivotLeft, pivotRight)

// Store pivot levels in arrays
var float[] supportLevels = array.new_float(0)
var float[] resistanceLevels = array.new_float(0)
var int[] supportBars = array.new_int(0)
var int[] resistanceBars = array.new_int(0)

// Add new pivot low (support)
if not na(pivotLow)
    // Check if level is unique (not within 1% of existing)
    isUnique = true
    if array.size(supportLevels) > 0
        for i = 0 to array.size(supportLevels) - 1
            existingLevel = array.get(supportLevels, i)
            if math.abs(pivotLow - existingLevel) / existingLevel < 0.01
                isUnique := false
                break

    if isUnique
        array.push(supportLevels, pivotLow)
        array.push(supportBars, bar_index - pivotRight)

// Add new pivot high (resistance)
if not na(pivotHigh)
    isUnique = true
    if array.size(resistanceLevels) > 0
        for i = 0 to array.size(resistanceLevels) - 1
            existingLevel = array.get(resistanceLevels, i)
            if math.abs(pivotHigh - existingLevel) / existingLevel < 0.01
                isUnique := false
                break

    if isUnique
        array.push(resistanceLevels, pivotHigh)
        array.push(resistanceBars, bar_index - pivotRight)

// ============================================
// MULTI-TIMEFRAME S&R (WEEKLY)
// ============================================
[weeklyHigh, weeklyLow, weeklyClose] = request.security(syminfo.tickerid, mtfTimeframe, [high, low, close])

weeklyPivotHigh = ta.pivothigh(weeklyHigh, 2, 2)
weeklyPivotLow = ta.pivotlow(weeklyLow, 2, 2)

var float[] weeklySupportLevels = array.new_float(0)
var float[] weeklyResistanceLevels = array.new_float(0)

if not na(weeklyPivotLow) and useMTF
    isUnique = true
    if array.size(weeklySupportLevels) > 0
        for i = 0 to array.size(weeklySupportLevels) - 1
            existingLevel = array.get(weeklySupportLevels, i)
            if math.abs(weeklyPivotLow - existingLevel) / existingLevel < 0.02
                isUnique := false
                break
    if isUnique
        array.push(weeklySupportLevels, weeklyPivotLow)

if not na(weeklyPivotHigh) and useMTF
    isUnique = true
    if array.size(weeklyResistanceLevels) > 0
        for i = 0 to array.size(weeklyResistanceLevels) - 1
            existingLevel = array.get(weeklyResistanceLevels, i)
            if math.abs(weeklyPivotHigh - existingLevel) / existingLevel < 0.02
                isUnique := false
                break
    if isUnique
        array.push(weeklyResistanceLevels, weeklyPivotHigh)

// ============================================
// CHECK MTF CONFLUENCE
// ============================================
isConfluent(float level, bool isSupport) =>
    result = false
    if useMTF
        checkArray = isSupport ? weeklySupportLevels : weeklyResistanceLevels
        if array.size(checkArray) > 0
            for i = 0 to array.size(checkArray) - 1
                weeklyLevel = array.get(checkArray, i)
                if math.abs(level - weeklyLevel) / level * 100 < confluenceThreshold
                    result := true
                    break
    result

// ============================================
// FIBONACCI EXTENSIONS FOR ATH
// ============================================
high52Week = ta.highest(high, 252)
low52Week = ta.lowest(low, 252)
isNearATH = (high52Week - close) / high52Week * 100 < athThreshold

// Find recent swing low for Fibonacci
recentSwingLow = ta.lowest(low, 60)

// Calculate Fibonacci extensions
fib127 = high52Week + (high52Week - recentSwingLow) * 0.272
fib161 = high52Week + (high52Week - recentSwingLow) * 0.618
fib200 = high52Week + (high52Week - recentSwingLow) * 1.0

// ============================================
// DRAW SUPPORT & RESISTANCE LINES
// ============================================
// Clean up old lines on each bar
var line[] supportLines = array.new_line(0)
var line[] resistanceLines = array.new_line(0)
var label[] supportLabels = array.new_label(0)
var label[] resistanceLabels = array.new_label(0)

// Delete all existing lines and labels
if barstate.islast
    // Clear old drawings (check size > 0 before looping)
    if array.size(supportLines) > 0
        for i = 0 to array.size(supportLines) - 1
            line.delete(array.get(supportLines, i))
    if array.size(resistanceLines) > 0
        for i = 0 to array.size(resistanceLines) - 1
            line.delete(array.get(resistanceLines, i))
    if array.size(supportLabels) > 0
        for i = 0 to array.size(supportLabels) - 1
            label.delete(array.get(supportLabels, i))
    if array.size(resistanceLabels) > 0
        for i = 0 to array.size(resistanceLabels) - 1
            label.delete(array.get(resistanceLabels, i))

    array.clear(supportLines)
    array.clear(resistanceLines)
    array.clear(supportLabels)
    array.clear(resistanceLabels)

    // Get current price for filtering
    currentPrice = close

    // Draw Support Lines (below current price)
    drawnSupport = 0
    if showSupport and array.size(supportLevels) > 0
        // Sort by proximity to current price (descending - nearest first)
        for i = array.size(supportLevels) - 1 to 0
            if drawnSupport >= maxLevels
                break
            level = array.get(supportLevels, i)
            if level < currentPrice
                isMTF = isConfluent(level, true)
                lineColor = isMTF ? mtfSupportColor : supportColor
                lineWidth = isMTF ? 2 : 1
                lineStyle = isMTF ? line.style_solid : line.style_dashed

                startBar = array.size(supportBars) > i ? array.get(supportBars, i) : bar_index - 100
                endBar = extendLines ? bar_index + 20 : bar_index

                newLine = line.new(startBar, level, endBar, level,
                     color=lineColor, width=lineWidth, style=lineStyle,
                     extend=extendLines ? extend.right : extend.none)
                array.push(supportLines, newLine)

                if showLabels
                    labelText = isMTF ? "S " + str.tostring(level, "#.##") + " [MTF]" : "S " + str.tostring(level, "#.##")
                    newLabel = label.new(bar_index + 5, level, labelText,
                         color=color.new(lineColor, 80), textcolor=lineColor,
                         style=label.style_label_left, size=size.small)
                    array.push(supportLabels, newLabel)

                drawnSupport += 1

    // Draw Resistance Lines (above current price)
    drawnResistance = 0
    if showResistance and array.size(resistanceLevels) > 0
        for i = array.size(resistanceLevels) - 1 to 0
            if drawnResistance >= maxLevels
                break
            level = array.get(resistanceLevels, i)
            if level > currentPrice
                isMTF = isConfluent(level, false)
                lineColor = isMTF ? mtfResistanceColor : resistanceColor
                lineWidth = isMTF ? 2 : 1
                lineStyle = isMTF ? line.style_solid : line.style_dashed

                startBar = array.size(resistanceBars) > i ? array.get(resistanceBars, i) : bar_index - 100
                endBar = extendLines ? bar_index + 20 : bar_index

                newLine = line.new(startBar, level, endBar, level,
                     color=lineColor, width=lineWidth, style=lineStyle,
                     extend=extendLines ? extend.right : extend.none)
                array.push(resistanceLines, newLine)

                if showLabels
                    labelText = isMTF ? "R " + str.tostring(level, "#.##") + " [MTF]" : "R " + str.tostring(level, "#.##")
                    newLabel = label.new(bar_index + 5, level, labelText,
                         color=color.new(lineColor, 80), textcolor=lineColor,
                         style=label.style_label_left, size=size.small)
                    array.push(resistanceLabels, newLabel)

                drawnResistance += 1

    // Draw Fibonacci Extensions if near ATH
    if useFibonacci and isNearATH and drawnResistance < maxLevels
        // Only draw if no natural resistance above
        if drawnResistance == 0 or (drawnResistance > 0 and array.size(resistanceLines) > 0)
            // Fib 127.2%
            fibLine1 = line.new(bar_index - 50, fib127, bar_index + 20, fib127,
                 color=color.new(color.orange, 30), width=1, style=line.style_dotted,
                 extend=extendLines ? extend.right : extend.none)
            array.push(resistanceLines, fibLine1)
            if showLabels
                fibLabel1 = label.new(bar_index + 5, fib127, "Fib 127.2% " + str.tostring(fib127, "#.##"),
                     color=color.new(color.orange, 80), textcolor=color.orange,
                     style=label.style_label_left, size=size.small)
                array.push(resistanceLabels, fibLabel1)

            // Fib 161.8%
            fibLine2 = line.new(bar_index - 50, fib161, bar_index + 20, fib161,
                 color=color.new(color.orange, 30), width=1, style=line.style_dotted,
                 extend=extendLines ? extend.right : extend.none)
            array.push(resistanceLines, fibLine2)
            if showLabels
                fibLabel2 = label.new(bar_index + 5, fib161, "Fib 161.8% " + str.tostring(fib161, "#.##"),
                     color=color.new(color.orange, 80), textcolor=color.orange,
                     style=label.style_label_left, size=size.small)
                array.push(resistanceLabels, fibLabel2)

// ============================================
// INFO TABLE
// ============================================
var table infoTable = table.new(position.top_right, 2, 6, bgcolor=color.new(color.black, 80), border_width=1)

if barstate.islast
    // Count confluent levels
    mtfSupportCount = 0
    mtfResistanceCount = 0

    if array.size(supportLevels) > 0
        for i = 0 to array.size(supportLevels) - 1
            if isConfluent(array.get(supportLevels, i), true)
                mtfSupportCount += 1

    if array.size(resistanceLevels) > 0
        for i = 0 to array.size(resistanceLevels) - 1
            if isConfluent(array.get(resistanceLevels, i), false)
                mtfResistanceCount += 1

    table.cell(infoTable, 0, 0, "STA S&R", text_color=color.white, text_size=size.small)
    table.cell(infoTable, 1, 0, "v1.0", text_color=color.gray, text_size=size.small)

    table.cell(infoTable, 0, 1, "Support Levels", text_color=supportColor, text_size=size.tiny)
    table.cell(infoTable, 1, 1, str.tostring(array.size(supportLevels)), text_color=color.white, text_size=size.tiny)

    table.cell(infoTable, 0, 2, "Resistance Levels", text_color=resistanceColor, text_size=size.tiny)
    table.cell(infoTable, 1, 2, str.tostring(array.size(resistanceLevels)), text_color=color.white, text_size=size.tiny)

    table.cell(infoTable, 0, 3, "MTF Confluent (S)", text_color=mtfSupportColor, text_size=size.tiny)
    table.cell(infoTable, 1, 3, str.tostring(mtfSupportCount), text_color=color.white, text_size=size.tiny)

    table.cell(infoTable, 0, 4, "MTF Confluent (R)", text_color=mtfResistanceColor, text_size=size.tiny)
    table.cell(infoTable, 1, 4, str.tostring(mtfResistanceCount), text_color=color.white, text_size=size.tiny)

    athStatus = isNearATH ? "YES" : "NO"
    athColor = isNearATH ? color.yellow : color.gray
    table.cell(infoTable, 0, 5, "Near ATH", text_color=athColor, text_size=size.tiny)
    table.cell(infoTable, 1, 5, athStatus, text_color=athColor, text_size=size.tiny)
